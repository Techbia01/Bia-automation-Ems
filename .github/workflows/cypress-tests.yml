name: Pruebas E2E con Cypress

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Ejecutar todos los d√≠as a las 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Permite ejecuci√≥n manual

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    name: Ejecutar pruebas Cypress
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci

      - name: Asegurar que el directorio de reportes existe
        run: |
          mkdir -p cypress/reports

      - name: Ejecutar pruebas Cypress
        run: npm run test
        continue-on-error: true
        env:
          CYPRESS_BASE_URL: https://web.dev.bia.app
          NODE_TLS_REJECT_UNAUTHORIZED: 0
          CYPRESS_VERIFY_TIMEOUT: 120000

      - name: Generar reportes despu√©s de las pruebas
        if: always()
        run: |
          echo "üìä Generando reportes..."
          
          # Verificar si hay archivos JSON de reporte
          if ls cypress/reports/*.json 1> /dev/null 2>&1; then
            echo "‚úÖ Se encontraron archivos JSON de reporte"
            npm run merge:reports || echo "‚ö†Ô∏è No se pudieron fusionar reportes"
            
            # Verificar si se gener√≥ el report.json
            if [ -f "cypress/reports/report.json" ]; then
              echo "‚úÖ Generando reporte HTML..."
              npm run generate:report || echo "‚ö†Ô∏è No se pudo generar reporte HTML"
            else
              echo "‚ö†Ô∏è No se gener√≥ report.json despu√©s del merge"
            fi
          else
            echo "‚ö†Ô∏è No se encontraron archivos JSON de reporte. Las pruebas pueden haber fallado antes de generar reportes."
            echo "   Esto puede ocurrir si las pruebas fallan muy temprano o hay un error de configuraci√≥n."
          fi

      - name: Publicar reporte HTML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-report
          path: cypress/reports/report.html
          retention-days: 30
          if-no-files-found: warn

      - name: Publicar videos y screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-artifacts
          path: |
            cypress/videos/**/*.mp4
            cypress/screenshots/**/*.png
          retention-days: 7

      - name: Generar y enviar notificaci√≥n detallada a Slack
        if: always()
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_WORKFLOW: ${{ github.workflow }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          echo "üîî Preparando notificaci√≥n a Slack..."
          
          # Verificar que el script existe
          if [ ! -f "scripts/generate-slack-message.js" ]; then
            echo "‚ùå Error: No se encontr√≥ el script generate-slack-message.js"
            exit 1
          fi
          
          # Verificar que el webhook URL est√° configurado
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "‚ö†Ô∏è SLACK_WEBHOOK_URL no est√° configurado. Saltando notificaci√≥n."
            exit 0
          fi
          
          # Generar payload JSON usando el script de Node.js
          echo "üìù Generando mensaje de Slack..."
          echo "üìÇ Verificando si existe report.json..."
          if [ -f "cypress/reports/report.json" ]; then
            echo "‚úÖ Reporte JSON encontrado"
            ls -lh cypress/reports/report.json
          else
            echo "‚ö†Ô∏è Reporte JSON no encontrado, buscando archivos JSON..."
            ls -la cypress/reports/*.json 2>/dev/null || echo "No se encontraron archivos JSON"
          fi
          
          PAYLOAD=$(node scripts/generate-slack-message.js 2>&1)
          PAYLOAD_EXIT_CODE=$?
          
          if [ $PAYLOAD_EXIT_CODE -ne 0 ] || [ -z "$PAYLOAD" ]; then
            echo "‚ö†Ô∏è Error al generar payload (exit code: $PAYLOAD_EXIT_CODE)"
            echo "Output del script:"
            echo "$PAYLOAD"
            echo "‚ö†Ô∏è Enviando notificaci√≥n b√°sica..."
            PAYLOAD=$(cat <<EOF
          {
            "text": "üß™ Reporte de Pruebas Cypress - EMS",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*üß™ Reporte de Pruebas Cypress*\n\n*Repositorio:* $GITHUB_REPOSITORY\n*Rama:* $GITHUB_REF_NAME\n*Commit:* ${GITHUB_SHA:0:7}\n*Ejecutado por:* $GITHUB_ACTOR\n\n<${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}|üìã Ver ejecuci√≥n completa>"
                }
              }
            ]
          }
          EOF
          )
          else
            echo "‚úÖ Payload generado exitosamente"
            echo "Tama√±o del payload: $(echo "$PAYLOAD" | wc -c) caracteres"
          fi
          
          # Enviar a Slack
          echo "üì§ Enviando notificaci√≥n a Slack..."
          HTTP_CODE=$(curl -s -o /tmp/slack_response.txt -w "%{http_code}" \
            -X POST \
            -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            "$SLACK_WEBHOOK_URL")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Notificaci√≥n enviada exitosamente a Slack"
          else
            echo "‚ö†Ô∏è Error al enviar notificaci√≥n. C√≥digo HTTP: $HTTP_CODE"
            cat /tmp/slack_response.txt || true
            # No fallar el workflow si la notificaci√≥n falla
          fi
