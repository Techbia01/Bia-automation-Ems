name: Pruebas E2E con Cypress

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    - cron: '0 2 * * *'
  workflow_dispatch:

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    name: Ejecutar pruebas Cypress
    
    steps:
      - name: Checkout cÃ³digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci

      - name: Asegurar que el directorio de reportes existe
        run: mkdir -p cypress/reports

      - name: Ejecutar pruebas Cypress
        run: npm run test
        continue-on-error: true
        env:
          CYPRESS_BASE_URL: https://web.dev.bia.app
          NODE_TLS_REJECT_UNAUTHORIZED: 0

      - name: Generar reportes despuÃ©s de las pruebas
        if: always()
        run: |
          echo "ðŸ“Š Generando reportes..."
          if ls cypress/reports/*.json 1>/dev/null 2>&1; then
            echo "âœ… Archivos JSON encontrados"
            npm run merge:reports || true
            npm run generate:report || true
          else
            echo "âš ï¸ No se encontraron archivos JSON"
          fi

      - name: Publicar reporte HTML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-report
          path: cypress/reports/report.html
          retention-days: 30
          if-no-files-found: warn

      - name: Publicar videos y screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-artifacts
          path: |
            cypress/videos/**/*.mp4
            cypress/screenshots/**/*.png
          retention-days: 7

      - name: Enviar notificaciÃ³n a Slack
        if: always()
        continue-on-error: true
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_SHA: ${{ github.sha }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "âš ï¸ SLACK_WEBHOOK_URL no configurado"
            exit 0
          fi
          
          if [ -f "scripts/generate-slack-message.js" ] && [ -f "cypress/reports/report.json" ]; then
            PAYLOAD=$(node scripts/generate-slack-message.js 2>/dev/null)
          fi
          
          if [ -z "$PAYLOAD" ] || ! echo "$PAYLOAD" | grep -q '{'; then
            REPO_URL="$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID"
            COMMIT_SHORT="${GITHUB_SHA:0:7}"
            PAYLOAD="{\"text\":\"ðŸ§ª Pruebas Cypress - EMS\",\"blocks\":[{\"type\":\"section\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"*ðŸ§ª Reporte de Pruebas Cypress*\\n\\n*Repositorio:* $GITHUB_REPOSITORY\\n*Rama:* $GITHUB_REF_NAME\\n*Commit:* $COMMIT_SHORT\\n*Ejecutado por:* $GITHUB_ACTOR\\n\\n<$REPO_URL|ðŸ“‹ Ver ejecuciÃ³n completa>\"}}]}"
          fi
          
          curl -X POST -H 'Content-type: application/json' --data "$PAYLOAD" "$SLACK_WEBHOOK_URL" || echo "Error al enviar"
