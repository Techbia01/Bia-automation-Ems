name: Pruebas E2E con Cypress

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Ejecutar todos los d√≠as a las 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Permite ejecuci√≥n manual

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    name: Ejecutar pruebas Cypress
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci

      - name: Ejecutar pruebas Cypress
        run: npm run test:report
        continue-on-error: true
        env:
          CYPRESS_BASE_URL: https://web.dev.bia.app

      - name: Asegurar que el directorio de reportes existe
        if: always()
        run: |
          mkdir -p cypress/reports

      - name: Generar reporte JSON si no existe
        if: always()
        run: |
          if [ ! -f "cypress/reports/report.json" ]; then
            echo "‚ö†Ô∏è Reporte JSON no encontrado, generando..."
            npm run merge:reports || echo "‚ö†Ô∏è No se pudieron generar reportes JSON"
          else
            echo "‚úÖ Reporte JSON encontrado"
          fi

      - name: Generar reporte HTML si no existe
        if: always()
        run: |
          if [ ! -f "cypress/reports/report.html" ]; then
            echo "Generando reporte HTML..."
            npm run generate:report || true
          fi

      - name: Publicar reporte HTML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-report
          path: cypress/reports/report.html
          retention-days: 30

      - name: Publicar videos y screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-artifacts
          path: |
            cypress/videos/**/*.mp4
            cypress/screenshots/**/*.png
          retention-days: 7

      - name: Generar y enviar notificaci√≥n detallada a Slack
        if: always() && secrets.SLACK_WEBHOOK_URL != null
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_WORKFLOW: ${{ github.workflow }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          echo "üîî Preparando notificaci√≥n a Slack..."
          
          # Verificar que el script existe
          if [ ! -f "scripts/generate-slack-message.js" ]; then
            echo "‚ùå Error: No se encontr√≥ el script generate-slack-message.js"
            exit 1
          fi
          
          # Verificar que el webhook URL est√° configurado
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "‚ö†Ô∏è SLACK_WEBHOOK_URL no est√° configurado. Saltando notificaci√≥n."
            exit 0
          fi
          
          # Generar payload JSON usando el script de Node.js
          echo "üìù Generando mensaje de Slack..."
          PAYLOAD=$(node scripts/generate-slack-message.js)
          
          if [ -z "$PAYLOAD" ]; then
            echo "‚ö†Ô∏è No se pudo generar el payload. Enviando notificaci√≥n b√°sica..."
            PAYLOAD=$(cat <<EOF
          {
            "text": "üß™ Reporte de Pruebas Cypress - EMS",
            "blocks": [
              {
                "type": "section",
                "text": {
                  "type": "mrkdwn",
                  "text": "*üß™ Reporte de Pruebas Cypress*\n\n*Repositorio:* $GITHUB_REPOSITORY\n*Rama:* $GITHUB_REF_NAME\n*Commit:* ${GITHUB_SHA:0:7}\n*Ejecutado por:* $GITHUB_ACTOR\n\n<${GITHUB_SERVER_URL}/${GITHUB_REPOSITORY}/actions/runs/${GITHUB_RUN_ID}|üìã Ver ejecuci√≥n completa>"
                }
              }
            ]
          }
          EOF
          )
          fi
          
          # Enviar a Slack
          echo "üì§ Enviando notificaci√≥n a Slack..."
          HTTP_CODE=$(curl -s -o /tmp/slack_response.txt -w "%{http_code}" \
            -X POST \
            -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            "$SLACK_WEBHOOK_URL")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Notificaci√≥n enviada exitosamente a Slack"
          else
            echo "‚ö†Ô∏è Error al enviar notificaci√≥n. C√≥digo HTTP: $HTTP_CODE"
            cat /tmp/slack_response.txt || true
            # No fallar el workflow si la notificaci√≥n falla
          fi
