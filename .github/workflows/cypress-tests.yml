name: Pruebas E2E con Cypress

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]
  schedule:
    # Ejecutar todos los d√≠as a las 2:00 AM UTC
    - cron: '0 2 * * *'
  workflow_dispatch: # Permite ejecuci√≥n manual

jobs:
  cypress-run:
    runs-on: ubuntu-latest
    name: Ejecutar pruebas Cypress
    
    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Instalar dependencias
        run: npm ci

      - name: Asegurar que el directorio de reportes existe
        run: |
          mkdir -p cypress/reports

      - name: Ejecutar pruebas Cypress
        run: npm run test 2>&1 | tee cypress-test-output.log
        continue-on-error: true
        env:
          CYPRESS_BASE_URL: https://web.dev.bia.app
          NODE_TLS_REJECT_UNAUTHORIZED: 0
          CYPRESS_VERIFY_TIMEOUT: 120000

      - name: Generar reportes despu√©s de las pruebas
        if: always()
        run: |
          echo "üìä Generando reportes..."
          echo "üìÇ Contenido del directorio cypress/reports:"
          ls -la cypress/reports/ || echo "El directorio no existe o est√° vac√≠o"
          
          # Verificar si hay archivos JSON de reporte
          echo "üîç Buscando archivos JSON..."
          JSON_FILES=$(find cypress/reports -name "*.json" -type f 2>/dev/null | head -10)
          if [ -n "$JSON_FILES" ]; then
            echo "‚úÖ Se encontraron archivos JSON de reporte:"
            echo "$JSON_FILES"
            echo ""
            echo "üîÑ Fusionando reportes..."
            npm run merge:reports || echo "‚ö†Ô∏è No se pudieron fusionar reportes"
            
            # Verificar si se gener√≥ el report.json
            if [ -f "cypress/reports/report.json" ]; then
              echo "‚úÖ report.json generado exitosamente"
              echo "üìè Tama√±o del archivo: $(du -h cypress/reports/report.json | cut -f1)"
              echo "üîÑ Generando reporte HTML..."
              npm run generate:report || echo "‚ö†Ô∏è No se pudo generar reporte HTML"
            else
              echo "‚ö†Ô∏è No se gener√≥ report.json despu√©s del merge"
              echo "üìÇ Archivos en cypress/reports despu√©s del merge:"
              ls -la cypress/reports/ || true
            fi
          else
            echo "‚ö†Ô∏è No se encontraron archivos JSON de reporte."
            echo "üìÇ Buscando en otras ubicaciones posibles..."
            find . -name "*.json" -path "*/cypress/*" -type f 2>/dev/null | head -5 || echo "No se encontraron archivos JSON"
          fi

      - name: Publicar reporte HTML
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-report
          path: cypress/reports/report.html
          retention-days: 30
          if-no-files-found: warn

      - name: Publicar videos y screenshots
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: cypress-artifacts
          path: |
            cypress/videos/**/*.mp4
            cypress/screenshots/**/*.png
          retention-days: 7

      - name: Generar y enviar notificaci√≥n detallada a Slack
        if: always()
        continue-on-error: true
        env:
          GITHUB_REF_NAME: ${{ github.ref_name }}
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_RUN_ID: ${{ github.run_id }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_SERVER_URL: ${{ github.server_url }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_WORKFLOW: ${{ github.workflow }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          echo "üîî Preparando notificaci√≥n a Slack..."
          echo "üìã Variables de entorno:"
          echo "  GITHUB_REPOSITORY: $GITHUB_REPOSITORY"
          echo "  GITHUB_REF_NAME: $GITHUB_REF_NAME"
          echo "  GITHUB_RUN_ID: $GITHUB_RUN_ID"
          
          # Verificar que el webhook URL est√° configurado
          if [ -z "$SLACK_WEBHOOK_URL" ]; then
            echo "‚ùå ERROR: SLACK_WEBHOOK_URL no est√° configurado."
            echo "   Ve a Settings ‚Üí Secrets ‚Üí Actions y configura SLACK_WEBHOOK_URL"
            exit 0
          fi
          
          echo "‚úÖ Webhook URL configurado (longitud: ${#SLACK_WEBHOOK_URL} caracteres)"
          
          # Intentar generar payload detallado, si falla usar b√°sico
          PAYLOAD=""
          if [ -f "scripts/generate-slack-message.js" ] && [ -f "cypress/reports/report.json" ]; then
            echo "üìù Intentando generar mensaje detallado..."
            SCRIPT_OUTPUT=$(node scripts/generate-slack-message.js 2>/dev/null)
            if [ $? -eq 0 ] && [ -n "$SCRIPT_OUTPUT" ] && echo "$SCRIPT_OUTPUT" | grep -q '{'; then
              PAYLOAD="$SCRIPT_OUTPUT"
              echo "‚úÖ Payload detallado generado"
            fi
          fi
          
          # Si no hay payload detallado, usar b√°sico
          if [ -z "$PAYLOAD" ]; then
            echo "üìù Generando notificaci√≥n b√°sica..."
            PAYLOAD="{\"text\":\"üß™ Reporte de Pruebas Cypress - EMS\",\"blocks\":[{\"type\":\"section\",\"text\":{\"type\":\"mrkdwn\",\"text\":\"*üß™ Reporte de Pruebas Cypress*\\n\\n*Repositorio:* $GITHUB_REPOSITORY\\n*Rama:* $GITHUB_REF_NAME\\n*Commit:* ${GITHUB_SHA:0:7}\\n*Ejecutado por:* $GITHUB_ACTOR\\n\\n<$GITHUB_SERVER_URL/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID|üìã Ver ejecuci√≥n completa>\"}}]}"
          fi
          
          # Enviar a Slack
          echo "üì§ Enviando notificaci√≥n a Slack..."
          echo "Payload size: $(echo "$PAYLOAD" | wc -c) bytes"
          
          RESPONSE=$(curl -s -w "\n%{http_code}" \
            -X POST \
            -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            --max-time 10 \
            "$SLACK_WEBHOOK_URL" 2>&1)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Code: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "‚úÖ Notificaci√≥n enviada exitosamente a Slack"
          else
            echo "‚ùå Error al enviar. HTTP: $HTTP_CODE"
            echo "Respuesta: $BODY"
          fi
